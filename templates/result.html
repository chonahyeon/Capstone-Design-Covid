<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title>ì½”ë¡œë‚˜ ì˜ˆì¸¡ ì§„ë‹¨ì„œë¹„ìŠ¤</title>
        {% load static %}
        <style>
            
            body{
                background-color: #AAC4FF;
            }

            .map_wrap, .map_wrap * {font-family:'Malgun Gothic',dotum,'ë‹ì›€',sans-serif;font-size:12px;}
            /*.map_wrap {position:relative;width:100%;height:350px;}*/
            
            #category li {float:left;list-style: none;width:50px;border-right:1px solid #acacac;padding:6px 0;text-align: center; cursor: pointer;}
            #category li.on {background: #eee;}
            #category li:hover {background: #ffe6e6;border-left:1px solid #acacac;margin-left: -1px;}
            #category li:last-child{margin-right:0;border-right:0;}
            #category li span {display: block;margin:0 auto 3px;width:27px;height: 28px;}
           
            #category li .mart {background:url({% static 'trolley.png'%});}
            #category li .pharmacy {background:url({% static 'pill.png'%});}
            #category li .hospital {background:url({% static 'medicine.png'%});}
            #category li .store {background:url({% static 'convenience.png'%});}
            

            .placeinfo_wrap {position:absolute;bottom:28px;left:-150px;width:300px;}
            .placeinfo {position:relative;width:100%;border-radius:6px;border: 1px solid #ccc;border-bottom:2px solid #ddd;padding-bottom: 10px;background: #fff;}
            .placeinfo:nth-of-type(n) {border:0; box-shadow:0px 1px 2px #888;}
            .placeinfo_wrap .after {content:'';position:relative;margin-left:-12px;left:50%;width:22px;height:12px;background:url('https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/vertex_white.png')}
            .placeinfo a, .placeinfo a:hover, .placeinfo a:active{color:#fff;text-decoration: none;}
            .placeinfo a, .placeinfo span {display: block;text-overflow: ellipsis;overflow: hidden;white-space: nowrap;}
            .placeinfo span {margin:5px 5px 0 5px;cursor: default;font-size:13px;}
            .placeinfo .title {font-weight: bold; font-size:14px;border-radius: 6px 6px 0 0;margin: -1px -1px 0 -1px;padding:10px; color: #fff;background: #d95050;background: #d95050 url(https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/arrow_white.png) no-repeat right 14px center;}
            .placeinfo .tel {color:#0f7833;}
            .placeinfo .jibun {color:#999;font-size:11px;margin-top:0;}

            .title{
                text-align: center;
            }

            .content{
                width:90vw;
                margin-left:5vw;
                margin-right:5vw;
                background-color: #EEF1FF;
                text-align: center;
                box-shadow: 2px 5px 10px rgba(0, 0, 0, 0.5);
            }

            .sub-map{
                background-color: #D2DAFF;
                margin-top:5vh;
                margin-left:15vw;
                margin-right:10vw;
                width:60vw;
                box-shadow: 5px 5px 10px rgba(0, 0, 0.1, 0.1);
            }


        </style>
    </head>
    <body>
        
        <h1 class ="title">ì˜ˆì¸¡ ê²°ê³¼</h1>
        <div class="content">
            <h3>ë‹¹ì‹ ì´ ì…ë ¥í•œ ê°’ì€ {{kor_list}} </h3>
            <h3>4ë§Œê°œì˜ ë°ì´í„°ë¡œ ì˜ˆì¸¡í•œ ê²°ê³¼ëŠ” {{kor_pred}} ì…ë‹ˆë‹¤.</h3>     
            <a href="{% url 'survey' %}">ğŸ‘‰ ë©”ì¸í˜ì´ì§€ë¡œ ëŒì•„ê°€ê¸°</a>

            <div class="sub-map">
                <ul id="category">     
                    <li id="MT1" data-order="0"> 
                        <span class="mart"></span>
                        ë§ˆíŠ¸
                    </li>  
                    <li id="PM9" data-order="1"> 
                        <span class="category_bg pharmacy"></span>
                        ì•½êµ­
                    </li>  
                    </li>  
                    <li id="HP8" data-order="2"> 
                        <span class="category_bg hospital"></span>
                        ë³‘ì›
                    </li>  
                    <li id="CS2" data-order="3"> 
                        <span class="category_bg store"></span>
                        í¸ì˜ì 
                    </li>      
                </ul>
                <div id="map" style="width:60vw;height:60vh;"></div>
                <script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=1c461e735962dc3d83f03f40b8eb4959&libraries=services"></script>

            </div>
        </div>
            <script>
                // ë§ˆì»¤ë¥¼ í´ë¦­í–ˆì„ ë•Œ í•´ë‹¹ ì¥ì†Œì˜ ìƒì„¸ì •ë³´ë¥¼ ë³´ì—¬ì¤„ ì»¤ìŠ¤í…€ì˜¤ë²„ë ˆì´ì…ë‹ˆë‹¤
                var placeOverlay = new kakao.maps.CustomOverlay({zIndex:1}), 
                    contentNode = document.createElement('div'), // ì»¤ìŠ¤í…€ ì˜¤ë²„ë ˆì´ì˜ ì»¨í…ì¸  ì—˜ë¦¬ë¨¼íŠ¸ ì…ë‹ˆë‹¤ 
                    markers = [], // ë§ˆì»¤ë¥¼ ë‹´ì„ ë°°ì—´ì…ë‹ˆë‹¤
                    currCategory = ''; // í˜„ì¬ ì„ íƒëœ ì¹´í…Œê³ ë¦¬ë¥¼ ê°€ì§€ê³  ìˆì„ ë³€ìˆ˜ì…ë‹ˆë‹¤
                 
                var mapContainer = document.getElementById('map'), // ì§€ë„ë¥¼ í‘œì‹œí•  div 
                    mapOption = {
                        center: new kakao.maps.LatLng(37.566826, 126.9786567), // ì§€ë„ì˜ ì¤‘ì‹¬ì¢Œí‘œ
                        level: 5 // ì§€ë„ì˜ í™•ëŒ€ ë ˆë²¨
                    };  
                
                // ì§€ë„ë¥¼ ìƒì„±í•©ë‹ˆë‹¤    
                var map = new kakao.maps.Map(mapContainer, mapOption); 
                
                if (navigator.geolocation) {
                    // GeoLocationì„ ì´ìš©í•´ì„œ ì ‘ì† ìœ„ì¹˜ë¥¼ ì–»ì–´ì˜µë‹ˆë‹¤
                    navigator.geolocation.getCurrentPosition(function(position) {
                        
                        var lat = position.coords.latitude, // ìœ„ë„
                            lon = position.coords.longitude; // ê²½ë„
                        
                        var locPosition = new kakao.maps.LatLng(lat, lon); // ë§ˆì»¤ê°€ í‘œì‹œë  ìœ„ì¹˜ë¥¼ geolocationìœ¼ë¡œ ì–»ì–´ì˜¨ ì¢Œí‘œë¡œ ìƒì„±í•©ë‹ˆë‹¤
        
                        map.setCenter(locPosition);  
                        searchAddress(map.getCenter(), );
                    });
                }
                // ì¥ì†Œ ê²€ìƒ‰ ê°ì²´ë¥¼ ìƒì„±í•©ë‹ˆë‹¤
                var ps = new kakao.maps.services.Places(map); 
                
                // ì§€ë„ì— idle ì´ë²¤íŠ¸ë¥¼ ë“±ë¡í•©ë‹ˆë‹¤
                kakao.maps.event.addListener(map, 'idle', searchPlaces);
                
                // ì»¤ìŠ¤í…€ ì˜¤ë²„ë ˆì´ì˜ ì»¨í…ì¸  ë…¸ë“œì— css classë¥¼ ì¶”ê°€í•©ë‹ˆë‹¤ 
                contentNode.className = 'placeinfo_wrap';
                
                // ì»¤ìŠ¤í…€ ì˜¤ë²„ë ˆì´ì˜ ì»¨í…ì¸  ë…¸ë“œì— mousedown, touchstart ì´ë²¤íŠ¸ê°€ ë°œìƒí–ˆì„ë•Œ
                // ì§€ë„ ê°ì²´ì— ì´ë²¤íŠ¸ê°€ ì „ë‹¬ë˜ì§€ ì•Šë„ë¡ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ë¡œ kakao.maps.event.preventMap ë©”ì†Œë“œë¥¼ ë“±ë¡í•©ë‹ˆë‹¤ 
                addEventHandle(contentNode, 'mousedown', kakao.maps.event.preventMap);
                addEventHandle(contentNode, 'touchstart', kakao.maps.event.preventMap);
                
                // ì»¤ìŠ¤í…€ ì˜¤ë²„ë ˆì´ ì»¨í…ì¸ ë¥¼ ì„¤ì •í•©ë‹ˆë‹¤
                placeOverlay.setContent(contentNode);  
                
                // ê° ì¹´í…Œê³ ë¦¬ì— í´ë¦­ ì´ë²¤íŠ¸ë¥¼ ë“±ë¡í•©ë‹ˆë‹¤
                addCategoryClickEvent();
                
                // ì—˜ë¦¬ë¨¼íŠ¸ì— ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ë¥¼ ë“±ë¡í•˜ëŠ” í•¨ìˆ˜ì…ë‹ˆë‹¤
                function addEventHandle(target, type, callback) {
                    if (target.addEventListener) {
                        target.addEventListener(type, callback);
                    } else {
                        target.attachEvent('on' + type, callback);
                    }
                }
                
                // ì¹´í…Œê³ ë¦¬ ê²€ìƒ‰ì„ ìš”ì²­í•˜ëŠ” í•¨ìˆ˜ì…ë‹ˆë‹¤
                function searchPlaces() {
                    if (!currCategory) {
                        return;
                    }
                    
                    // ì»¤ìŠ¤í…€ ì˜¤ë²„ë ˆì´ë¥¼ ìˆ¨ê¹ë‹ˆë‹¤ 
                    placeOverlay.setMap(null);
                
                    // ì§€ë„ì— í‘œì‹œë˜ê³  ìˆëŠ” ë§ˆì»¤ë¥¼ ì œê±°í•©ë‹ˆë‹¤
                    removeMarker();
                    
                    ps.categorySearch(currCategory, placesSearchCB, {useMapBounds:true}); 
                }
                
                // ì¥ì†Œê²€ìƒ‰ì´ ì™„ë£Œëì„ ë•Œ í˜¸ì¶œë˜ëŠ” ì½œë°±í•¨ìˆ˜ ì…ë‹ˆë‹¤
                function placesSearchCB(data, status, pagination) {
                    if (status === kakao.maps.services.Status.OK) {
                
                        // ì •ìƒì ìœ¼ë¡œ ê²€ìƒ‰ì´ ì™„ë£Œëìœ¼ë©´ ì§€ë„ì— ë§ˆì»¤ë¥¼ í‘œì¶œí•©ë‹ˆë‹¤
                        displayPlaces(data);
                    } else if (status === kakao.maps.services.Status.ZERO_RESULT) {
                        // ê²€ìƒ‰ê²°ê³¼ê°€ ì—†ëŠ”ê²½ìš° í•´ì•¼í•  ì²˜ë¦¬ê°€ ìˆë‹¤ë©´ ì´ê³³ì— ì‘ì„±í•´ ì£¼ì„¸ìš”
                
                    } else if (status === kakao.maps.services.Status.ERROR) {
                        // ì—ëŸ¬ë¡œ ì¸í•´ ê²€ìƒ‰ê²°ê³¼ê°€ ë‚˜ì˜¤ì§€ ì•Šì€ ê²½ìš° í•´ì•¼í•  ì²˜ë¦¬ê°€ ìˆë‹¤ë©´ ì´ê³³ì— ì‘ì„±í•´ ì£¼ì„¸ìš”
                        
                    }
                }
                
                // ì§€ë„ì— ë§ˆì»¤ë¥¼ í‘œì¶œí•˜ëŠ” í•¨ìˆ˜ì…ë‹ˆë‹¤
                function displayPlaces(places) {
                
                    // ëª‡ë²ˆì§¸ ì¹´í…Œê³ ë¦¬ê°€ ì„ íƒë˜ì–´ ìˆëŠ”ì§€ ì–»ì–´ì˜µë‹ˆë‹¤
                    // ì´ ìˆœì„œëŠ” ìŠ¤í”„ë¼ì´íŠ¸ ì´ë¯¸ì§€ì—ì„œì˜ ìœ„ì¹˜ë¥¼ ê³„ì‚°í•˜ëŠ”ë° ì‚¬ìš©ë©ë‹ˆë‹¤
                    var order = document.getElementById(currCategory).getAttribute('data-order');
                    image_list = ['{% static 'trolley.png'%}',
                                '{% static 'pill.png'%}',
                                '{% static 'medicine.png'%}',
                                '{% static 'convenience.png'%}']
                    
                    
                    for ( var i=0; i<places.length; i++ ) {
                            // ë§ˆì»¤ë¥¼ ìƒì„±í•˜ê³  ì§€ë„ì— í‘œì‹œí•©ë‹ˆë‹¤
                            var marker = addMarker(new kakao.maps.LatLng(places[i].y, places[i].x), order);
                
                            // ë§ˆì»¤ì™€ ê²€ìƒ‰ê²°ê³¼ í•­ëª©ì„ í´ë¦­ í–ˆì„ ë•Œ
                            // ì¥ì†Œì •ë³´ë¥¼ í‘œì¶œí•˜ë„ë¡ í´ë¦­ ì´ë²¤íŠ¸ë¥¼ ë“±ë¡í•©ë‹ˆë‹¤
                            (function(marker, place) {
                                kakao.maps.event.addListener(marker, 'click', function() {
                                    displayPlaceInfo(place);
                                });
                            })(marker, places[i]);
                    }
                }
                
                // ë§ˆì»¤ë¥¼ ìƒì„±í•˜ê³  ì§€ë„ ìœ„ì— ë§ˆì»¤ë¥¼ í‘œì‹œí•˜ëŠ” í•¨ìˆ˜ì…ë‹ˆë‹¤
                function addMarker(position, order) {
                    var imageSrc = image_list[order], // ë§ˆì»¤ ì´ë¯¸ì§€ url, ìŠ¤í”„ë¼ì´íŠ¸ ì´ë¯¸ì§€ë¥¼ ì”ë‹ˆë‹¤
                        imageSize = new kakao.maps.Size(27, 28),  // ë§ˆì»¤ ì´ë¯¸ì§€ì˜ í¬ê¸°
                        imgOptions =  { offset: new kakao.maps.Point(11, 28)}, // ë§ˆì»¤ ì¢Œí‘œì— ì¼ì¹˜ì‹œí‚¬ ì´ë¯¸ì§€ ë‚´ì—ì„œì˜ ì¢Œí‘œ 
                        markerImage = new kakao.maps.MarkerImage(imageSrc, imageSize, imgOptions),
                            marker = new kakao.maps.Marker({
                            position: position, // ë§ˆì»¤ì˜ ìœ„ì¹˜
                            image: markerImage  //ë§ˆì»¤ ì‚¬ì´ì¦ˆ 27*28
                        });
                
                    marker.setMap(map); // ì§€ë„ ìœ„ì— ë§ˆì»¤ë¥¼ í‘œì¶œí•©ë‹ˆë‹¤
                    markers.push(marker);  // ë°°ì—´ì— ìƒì„±ëœ ë§ˆì»¤ë¥¼ ì¶”ê°€í•©ë‹ˆë‹¤
                
                    return marker;
                }
                
                // ì§€ë„ ìœ„ì— í‘œì‹œë˜ê³  ìˆëŠ” ë§ˆì»¤ë¥¼ ëª¨ë‘ ì œê±°í•©ë‹ˆë‹¤
                function removeMarker() {
                    for ( var i = 0; i < markers.length; i++ ) {
                        markers[i].setMap(null);
                    }   
                    markers = [];
                }
                
                // í´ë¦­í•œ ë§ˆì»¤ì— ëŒ€í•œ ì¥ì†Œ ìƒì„¸ì •ë³´ë¥¼ ì»¤ìŠ¤í…€ ì˜¤ë²„ë ˆì´ë¡œ í‘œì‹œí•˜ëŠ” í•¨ìˆ˜ì…ë‹ˆë‹¤
                function displayPlaceInfo (place) {
                    var content = '<div class="placeinfo">' +
                                    '   <a class="title" href="' + place.place_url + '" target="_blank" title="' + place.place_name + '">' + place.place_name + '</a>';   
                
                    if (place.road_address_name) {
                        content += '    <span title="' + place.road_address_name + '">' + place.road_address_name + '</span>' +
                                    '  <span class="jibun" title="' + place.address_name + '">(ì§€ë²ˆ : ' + place.address_name + ')</span>';
                    }  else {
                        content += '    <span title="' + place.address_name + '">' + place.address_name + '</span>';
                    }                
                   
                    content += '    <span class="tel">' + place.phone + '</span>' + 
                                '</div>' + 
                                '<div class="after"></div>';
                
                    contentNode.innerHTML = content;
                    placeOverlay.setPosition(new kakao.maps.LatLng(place.y, place.x));
                    placeOverlay.setMap(map);  
                }
                
                
                // ê° ì¹´í…Œê³ ë¦¬ì— í´ë¦­ ì´ë²¤íŠ¸ë¥¼ ë“±ë¡í•©ë‹ˆë‹¤
                function addCategoryClickEvent() {
                    var category = document.getElementById('category'),
                        children = category.children;
                
                    for (var i=0; i<children.length; i++) {
                        children[i].onclick = onClickCategory;
                    }
                }
                
                // ì¹´í…Œê³ ë¦¬ë¥¼ í´ë¦­í–ˆì„ ë•Œ í˜¸ì¶œë˜ëŠ” í•¨ìˆ˜ì…ë‹ˆë‹¤
                function onClickCategory() {
                    var id = this.id,
                        className = this.className;
                
                    placeOverlay.setMap(null);
                
                    if (className === 'on') {
                        currCategory = '';
                        changeCategoryClass();
                        removeMarker();
                    } else {
                        currCategory = id;
                        changeCategoryClass(this);
                        searchPlaces();
                    }
                }
                
                // í´ë¦­ëœ ì¹´í…Œê³ ë¦¬ì—ë§Œ í´ë¦­ëœ ìŠ¤íƒ€ì¼ì„ ì ìš©í•˜ëŠ” í•¨ìˆ˜ì…ë‹ˆë‹¤
                function changeCategoryClass(el) {
                    var category = document.getElementById('category'),
                        children = category.children,
                        i;
                
                    for ( i=0; i<children.length; i++ ) {
                        children[i].className = '';
                    }
                
                    if (el) {
                        el.className = 'on';
                    } 
                } 


                </script>
    </body>
</html>